name: Security Scan (Snyk + Semgrep)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # --------------------
      # SNYK (SCA)
      # --------------------
      - name: Run Snyk on requirements.txt
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.TOKEN_SNYK }}
        with:
          command: test
          args: --file=requirements.txt --sarif-file-output=snyk.sarif
        continue-on-error: true

      - name: Upload Snyk SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk.sarif
          category: snyk-python-sca

      # --------------------
      # SEMGREP (SAST) â€” CLI DIRECT
      # --------------------
      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config p/python \
            --config p/flask \
            --config p/security-audit \
            --sarif \
            --output semgrep.sarif || true

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep.sarif
          category: semgrep
